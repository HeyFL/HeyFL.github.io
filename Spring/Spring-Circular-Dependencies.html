<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><title>【Spring源码分析】循环依赖的处理 - 神奇宝贝大师的技术博客</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="[原创]个人理解，请批判接受，有误请指正。转载请注明出处: https://heyfl.github.io/Spring/Spring-Circular-Dependencies.html   看源码的同学可以查看我的GitHub 上面在官方的基础上加入了大量中文注释，帮助理解   要了解的知识 什么是循环依赖"><meta name="keywords" content="Spring,源码分析"><meta property="og:type" content="article"><meta property="og:title" content="【Spring源码分析】循环依赖的处理"><meta property="og:url" content="https://heyfl.github.io/Spring/Spring-Circular-Dependencies.html"><meta property="og:site_name" content="神奇宝贝大师的技术博客"><meta property="og:description" content="[原创]个人理解，请批判接受，有误请指正。转载请注明出处: https://heyfl.github.io/Spring/Spring-Circular-Dependencies.html   看源码的同学可以查看我的GitHub 上面在官方的基础上加入了大量中文注释，帮助理解   要了解的知识 什么是循环依赖"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://heyfl.github.io/images/Spring循环依赖/bean的创建流程.png"><meta property="og:updated_time" content="2019-10-08T14:00:37.321Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="【Spring源码分析】循环依赖的处理"><meta name="twitter:description" content="[原创]个人理解，请批判接受，有误请指正。转载请注明出处: https://heyfl.github.io/Spring/Spring-Circular-Dependencies.html   看源码的同学可以查看我的GitHub 上面在官方的基础上加入了大量中文注释，帮助理解   要了解的知识 什么是循环依赖"><meta name="twitter:image" content="https://heyfl.github.io/images/Spring循环依赖/bean的创建流程.png"><link rel="icon" href="/images/avatar.png"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><link rel="stylesheet" href="/css/back-to-top.css"><link rel="stylesheet" href="/css/progressbar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="/css/style.css"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand is-flex-center"> <a class="navbar-item navbar-logo" href="/"><img src="/images/avatar.png" alt="【Spring源码分析】循环依赖的处理" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"> <a class="navbar-item" href="/">主页</a> <a class="navbar-item" href="/archives">归档</a> <a class="navbar-item" href="/categories">分类</a> <a class="navbar-item" href="/tags">标签</a> <a class="navbar-item" href="/about/about.html">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" title="GitHub" href="https://github.com/HeyFL" rel="external nofollow noopener noreferrer"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container" style="max-width:80vw;width:80vw"><div class="columns"><div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card" style="border-style:solid;border-width:2px;border-color:#737373"><div class="card-content article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"> 【Spring源码分析】循环依赖的处理</h1><div class="post-meta"><div class="level-left" style="width:100%;display:block;text-align:center"><span><i class="far fa-calendar-alt"></i> <span>发表于</span> <span>2019-05-22</span></span> <span class="post-meta-divider">|</span><span class="far fa-eye"></span> <span id="busuanzi_container_page_pv" class="level-item has-text-grey">被围观 <span id="busuanzi_value_page_pv" class="foot-count">无数</span> 次</span><br><span><span class="far fa-folder"></span> <span>分类于</span> <span class="is-size-6 has-text-grey has-mr-7">#</span> <a class="has-link-grey -link" href="/tags/Spring/">Spring</a>, <a class="has-link-grey -link" href="/tags/源码分析/">源码分析</a></span> <span class="post-meta-divider">|</span><i class="far fa-clock"></i> <span>13 分钟 读完 (大约 1931 个字)</span></div></div><div class="content"><blockquote><p><font size="3" color="red">[原创]</font>个人理解，请批判接受，有误请指正。转载请注明出处: <a href="#">https://heyfl.github.io/Spring/Spring-Circular-Dependencies.html</a></p></blockquote><blockquote><p>看源码的同学可以查看我的<a href="https://github.com/HeyFL/spring-framework" rel="external nofollow noopener noreferrer" target="_blank">GitHub</a> 上面在官方的基础上加入了<code>大量中文注释</code>，帮助理解</p></blockquote><hr><h2 id="要了解的知识"><strong>要了解的知识</strong></h2><h3 id="span-id-circulardependencies-span-什么是循环依赖"><span id="circularDependencies"></span><strong>什么是循环依赖</strong></h3><pre class="mermaid">    graph LR
A-->B
B-->C
C-->A</pre><h3 id="存在哪些循环依赖"><strong>存在哪些循环依赖</strong></h3><ol><li>Setter循环依赖(可以被解决)</li><li>构造循环依赖(报错)</li><li>基于Prototype类型的循环依赖(报错)</li></ol><h3 id="span-id-beancreate-span-bean的创建步骤"><span id="beanCreate"></span><strong>Bean的创建步骤</strong></h3><div align="center"><img src="/images/Spring循环依赖/bean的创建流程.png" alt="bean的创建流程"></div><blockquote><p>看源码的同学可以找到源码：<br> 环节1~4的代码在<code>AbstractAutowireCapableBeanFactory#doCreateBean</code>方法中<br><br> 环节5的代码在<code>DefaultSingletonBeanRegistry#getSingleton(String,ObjectFactory)</code>方法的<code>addSingleton(beanName, singletonObject);</code>中</p></blockquote><hr><h2 id="spring是怎么处理循环依赖的-对于单例bean"><strong>Spring是怎么处理循环依赖的（对于单例Bean）</strong></h2><h3 id="实现原理"><strong>实现原理</strong></h3><blockquote><p>Spring在创建<code>单例BeanA</code>的时候会先把BeanA(仅执行完构造方法)给放到三级缓存中，<br> 当其他Bean或业务代码在BeanA<code>[创建完之前]</code>需要用到，<br> 那么Spring就会把这个 还没进行<code>[属性注入]</code> <code>[调用init方法]</code>的BeanA提前暴露给这些Bean，并且把BeanA提到二级缓存中</p></blockquote><h3 id="三级缓存"><strong>三级缓存</strong></h3><p>首先咱们得知道三级缓存包括哪些：</p><ul><li>DefaultSingletonBeanRegistry#singletonObjects</li></ul><blockquote><p>单例对象的cache 只有<code>[创建完成(只调用了构造方法)]</code>&amp;&amp;<code>[初始化属性完成]</code>的才会放入这里 <font size="1" color="gray">(这是一级缓存 我们平时说Spring是个大工厂，所有的创建好的bean都可以从Spring缓存里拿。 这里面说的缓存就是一级缓存)</font></p></blockquote><ul><li>DefaultSingletonBeanRegistry#earlySingletonObjects</li></ul><blockquote><p>存放提前曝光的单例对象 只会放入<code>[创建完成(只调用了构造方法)]</code>&amp;&amp; <code>[被提前曝光的]</code> 的bean <font size="1" color="gray">(用于解决<code>[循环依赖]</code>的2级缓存)</font></p></blockquote><ul><li>DefaultSingletonBeanRegistry#singletonFactories</li></ul><blockquote><p>单例对象工厂的cache 只会放入<code>[创建完成(只调用了构造方法)]</code>的beanFactory <font size="1" color="gray">(用于解决<code>[循环依赖]</code>的3级缓存)</font></p></blockquote><h2 id="span-id-code1-span-解决循环依赖核心代码"><span id="code1"></span><strong>解决循环依赖核心代码</strong></h2><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@Nullable</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-keyword">boolean</span> allowEarlyReference)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-comment">//desc  先从singletonObjects（一级缓存）取</span></span><br><span class="line">    Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.get(beanName);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        <span class="hljs-comment">//desc  取不到且创建中,那么这里使用同步锁阻塞一会,等待创建完成</span></span><br><span class="line">        <span class="hljs-comment">//❤这里会发现 当真正创建完bean时会调用addSingletonFactory()  这时候也会锁住singletonObjects❤</span></span><br><span class="line">        <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.singletonObjects) &#123;</span><br><span class="line">            <span class="hljs-comment">//desc 同步阻塞+尝试从earlySingletonObjects(二级缓存)获取</span></span><br><span class="line">            singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.get(beanName);</span><br><span class="line">            <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-keyword">null</span> &amp;&amp; allowEarlyReference) &#123;</span><br><span class="line">                <span class="hljs-comment">//desc 如果二级缓存取不到&amp;&amp;允许从singletonFactories通过getObject获取</span></span><br><span class="line">                <span class="hljs-comment">//desc 通过singletonFactory.getObject()(三级缓存)获取工厂创建该bean</span></span><br><span class="line">                ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-keyword">this</span>.singletonFactories.get(beanName);</span><br><span class="line">                <span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">                    <span class="hljs-comment">//desc 通过三级缓存的Factory创建目标bean  并放入2级缓存</span></span><br><span class="line">                    singletonObject = singletonFactory.getObject();</span><br><span class="line">                    <span class="hljs-keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</span><br><span class="line">                    <span class="hljs-keyword">this</span>.singletonFactories.remove(beanName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> singletonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>其实这里做的事情和上面原理说的一样:<br> 因为Spring在创建<code>单例BeanA</code>的时候会<code>先把仅仅初始化完成,未注入属性的BeanA</code><font size="1"><a href="#beanCreate">(对应图中步骤1)</a></font>给放到<code>三级缓存</code>中，<br> 如果其他Bean在BeanA创建完之前需要用到(循环依赖就是这种场景)，<br> 那么Spring就会把这个BeanA提前暴露给这些Bean，并且把BeanA提到<code>二级缓存</code>中。</p><p>这样子，这些Bean就成功的获取到一个<code>仅仅初始化完成,未注入属性的BeanA</code></p></blockquote><h2 id="场景分析"><strong>场景分析</strong></h2><blockquote><p>假设现在有3个Bean ABC发生了Setter循环依赖<a href="#circularDependencies">(如本文最上面的图)</a><br> 通过<a href="#beanCreate">如上方式</a>,，Spring完全可以帮我们解决单例之间的Setter循环依赖问题让循环依赖的Bean之间获取到一个<code>仅仅初始化完成,未注入属性的BeanA</code><br> 这么说可能有些抽象，咱们尝试来还原该情况发生时发生了什么事情</p></blockquote><ul><li>现在getBeanA，会先去<a href="#code1">缓存里</a>getA，这时候A还没被创建，故进行A的创建流程</li><li>因为A依赖于B，所以A会执行到<a href="#beanCreate">createBean流程第三步</a>的populateBean，然后会去getB<code>(经过了第二步A已经被放入三级缓存中)</code></li><li>同理，B依赖C，所以B会执行到<a href="#beanCreate">createBean流程第三步</a>的populateBean，然后会去getC<code>(经过了第二步B已经被放入三级缓存中)</code></li><li>C依赖于A，也同理，但是这时候再去getA的时候，会发现又是一个getBeanA流程，但是这时候<a href="#code1">在三级缓存里</a>getA已经能get到对象了</li><li>获取到这个缓存中的A之后，完成beanC的属性注入、初始化等操作。这样，就完成beanC的整个创建流程；</li><li>同理，B、A也一样： 这样逐级返回，这样，就完成了整个getBeanA的流程，虽然过程中存在循环依赖，但不会令getBean流程出现异常</li></ul><p>至此，Spring完美地给我们处理了Setter循环依赖。</p><p>其实，换成代码理解可能更加简单:D</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A a = <span class="hljs-keyword">new</span> A();</span><br><span class="line">B b = <span class="hljs-keyword">new</span> B();</span><br><span class="line">C c = <span class="hljs-keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">a.setB(b);</span><br><span class="line">b.setC(c);</span><br><span class="line">c.setA(a);</span><br></pre></td></tr></table></figure><h2 id="其它一些补充"><strong>其它一些补充</strong></h2><h3 id="为什么构造循环依赖不能被解决-font-size-1-bean创建过程中没有放入缓存-font"><strong>为什么构造循环依赖不能被解决</strong><font size="1">（Bean创建过程中没有放入缓存）</font></h3><p><a href="#beanCreate">参考createBean流程</a></p><blockquote><p>根据上图的流程，createBeanInstance调用的实际上是<code>构造方法</code>，调用前还没把任何东西放入<code>缓存</code>中。<br> 这时候如果出现<code>基于构造方法的循环依赖</code>，那么是不可能成功的，试想一下：<br> newA的时候依赖于B<br> newB的时候依赖于C<br> newC的时候又反过来依赖于刚才的A<br> 而这时候A还没被new出来！这时候异常就出现了</p></blockquote><p>上述情况换成代码理解就成了</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A a = <span class="hljs-keyword">new</span> A(<span class="hljs-keyword">new</span> B(<span class="hljs-keyword">new</span> C(<span class="hljs-keyword">new</span> A(<span class="hljs-keyword">new</span> ..........))));</span><br></pre></td></tr></table></figure><h3 id="为什么prototype类型的循环依赖无法被解决"><strong>为什么prototype类型的循环依赖无法被解决</strong></h3><blockquote><p>首先咱们得先了解下prototype的bean创建流程</p></blockquote><pre class="mermaid">    graph TD
A[createBeanInstance]  
C[populateBean]  
E[return Bean]  
A--调用Bean的构造方法得到一个空Bean-->C  
C--为Bean注入属性-->E</pre><p>从流程可见，prototype的Bean创建过程中<code>压根就没有对生成完的bean进行缓存</code><br> 每一个Bean都是<code>实时创建/使用</code>的<br> 根据上面的流程，我们很容易发现，这种不使用缓存的情况压根不允许存在循环依赖，因为：</p><ul><li>A依赖于B，这得实时去创建A和B</li><li>B依赖于C，也得实时去创建C</li><li>创建C的时候发现C依赖于A，然鹅A没被缓存<font size="1" color="gay">（当然，其实prototype压根不会去查缓存）</font></li><li>那这时候程序就会无限循环下去了<font size="1" color="gay">(当然 spring会检测到这种异常,中断这次getBean)</font></li></ul><p>所以，prototype类型的循环依赖是不能被解决、也不允许出现的</p><p><code>伪代码</code>大致可以理解为：</p><figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A a = <span class="hljs-keyword">new</span> A(<span class="hljs-keyword">new</span> B().setC(<span class="hljs-keyword">new</span> C().setA(<span class="hljs-keyword">new</span> A().setB(......))));</span><br></pre></td></tr></table></figure><h2 id="总结"><strong>总结</strong></h2><p>至此，循环依赖的讨论到此结束。其实，说白了就是：</p><ol><li>只有<code>[单例Bean之间]</code>的的循环依赖才能被解决<font size="1" color="gray">(因为只有单例Bean会被缓存到2级/3级缓存中 用以解决循环依赖)</font></li><li>只有<code>[基于Setter属性注入]</code>循环依赖才能被解决<font size="1" color="gray">(因为只有基于Setter属性注入的Bean，才能在通过new调用构造方法后，把bean放入2级/3级缓存)</font></li><li><code>[构造注入]</code> 和 <code>[prototype类型的bean]</code>的循环依赖无法被解决 <font size="1" color="gray">（因为没办法放入2级/3级缓存中）</font></li></ol><hr></div><div class="level is-size-7 is-uppercase"><div class="level-start"><div class="level-item"> <span class="is-size-6 has-text-grey has-mr-7">#</span> <a class="has-link-grey -link" href="/tags/Spring/">Spring</a>, <a class="has-link-grey -link" href="/tags/源码分析/">源码分析</a></div></div></div></div><div style="text-align:center;color:#ccc;font-size:14px"> ------ 本文结束<i class="fa fa-paw"></i>感谢您的阅读 ------</div></div><div class="card card-transparent"><div class="level post-navigation is-flex-wrap is-mobile"><div class="level-start"><a class="level level-item has-link-grey article-nav-prev" href="/database/innodb-record-level-locks.html"><i class="level-item fas fa-chevron-left"></i> <span class="level-item">MySQL锁</span></a></div><div class="level-end"> <a class="level level-item has-link-grey article-nav-next" href="/JVM/JVM-Memory-Structure-Stack.html"><span class="level-item">java虚拟机栈的内存结构</span><i class="level-item fas fa-chevron-right"></i></a></div></div></div><div class="card"><div class="card-content"><h3 class="title is-5 has-text-weight-normal">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css"><script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment=new Gitment({id:"Wed May 22 2019 11:22:00 GMT+0800",owner:"HeyFL",repo:"heyfl.github.io",oauth:{client_id:"5e29b8e11983abda2f99",client_secret:"1ebe24de503d7b6a285f9e4ac48fe6cad3f37cbe"}});gitment.render("comment-container")</script></div></div></div><div class="column is-4-tablet is-4-desktop is-3-widescreen has-order-1 column-left"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered"><div><figure class="image container is-128x128 has-mb-6"> <img class="is-rounded" src="/images/avatar.png" alt="Pokémon Master"></figure><p class="is-size-4 is-block"> Pokémon Master</p><p class="is-size-6 is-block"> Web Developer &amp; Designer</p><p class="is-size-6 is-flex is-flex-center has-text-grey"><i class="fas fa-map-marker-alt has-mr-7"></i> <span>ShenZhen, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading"> 文章</p><p class="title has-text-weight-normal"> 13</p></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading"> 分类</p><p class="title has-text-weight-normal"> 10</p></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading"> 标签</p><p class="title has-text-weight-normal"> 17</p></div></div></nav><div class="level"> <a class="level-item button is-link is-rounded" href="https://github.com/HeyFL" rel="external nofollow noopener noreferrer" target="_blank">关注我</a></div><div class="level is-mobile"><a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/HeyFL" rel="external nofollow noopener noreferrer"><i class="fab fa-github"></i></a><a class="level-item button is-white is-marginless" target="_blank" title="QQ(361389383)" href="tencent://message/?uin=361389383" rel="external nofollow noopener noreferrer"><i class="fab fa-qq"></i></a></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label"> 分类</h3><ul class="menu-list"><li> <a class="level is-marginless" href="/categories/Bug-Log-Optimization/"><span class="level-start"><span class="level-item">Bug-Log&Optimization</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/Distributed/"><span class="level-start"><span class="level-item">Distributed</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/JVM/"><span class="level-start"><span class="level-item">JVM</span></span> <span class="level-end"><span class="level-item tag">2</span></span></a></li><li> <a class="level is-marginless" href="/categories/Make-A-Little-Progress-Every-Day/"><span class="level-start"><span class="level-item">Make-A-Little-Progress-Every-Day</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/Spring/"><span class="level-start"><span class="level-item">Spring</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/about/"><span class="level-start"><span class="level-item">about</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/bookmarks/"><span class="level-start"><span class="level-item">bookmarks</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/database/"><span class="level-start"><span class="level-item">database</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/kafka/"><span class="level-start"><span class="level-item">kafka</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/categories/redis/"><span class="level-start"><span class="level-item">redis</span></span> <span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label"> 目录</h3><ul class="menu-list"><li> <a class="is-flex" href="#要了解的知识"><span class="has-mr-6">1</span> <span>要了解的知识</span></a><ul class="menu-list"><li> <a class="is-flex" href="#span-id-circulardependencies-span-什么是循环依赖"><span class="has-mr-6">1.1</span> <span>什么是循环依赖</span></a></li><li> <a class="is-flex" href="#存在哪些循环依赖"><span class="has-mr-6">1.2</span> <span>存在哪些循环依赖</span></a></li><li> <a class="is-flex" href="#span-id-beancreate-span-bean的创建步骤"><span class="has-mr-6">1.3</span> <span>Bean的创建步骤</span></a></li></ul></li><li> <a class="is-flex" href="#spring是怎么处理循环依赖的-对于单例bean"><span class="has-mr-6">2</span> <span>Spring是怎么处理循环依赖的（对于单例Bean）</span></a><ul class="menu-list"><li> <a class="is-flex" href="#实现原理"><span class="has-mr-6">2.1</span> <span>实现原理</span></a></li><li> <a class="is-flex" href="#三级缓存"><span class="has-mr-6">2.2</span> <span>三级缓存</span></a></li></ul></li><li> <a class="is-flex" href="#span-id-code1-span-解决循环依赖核心代码"><span class="has-mr-6">3</span> <span>解决循环依赖核心代码</span></a></li><li> <a class="is-flex" href="#场景分析"><span class="has-mr-6">4</span> <span>场景分析</span></a></li><li> <a class="is-flex" href="#其它一些补充"><span class="has-mr-6">5</span> <span>其它一些补充</span></a><ul class="menu-list"><li> <a class="is-flex" href="#为什么构造循环依赖不能被解决-font-size-1-bean创建过程中没有放入缓存-font"><span class="has-mr-6">5.1</span> <span>为什么构造循环依赖不能被解决（Bean创建过程中没有放入缓存）</span></a></li><li> <a class="is-flex" href="#为什么prototype类型的循环依赖无法被解决"><span class="has-mr-6">5.2</span> <span>为什么prototype类型的循环依赖无法被解决</span></a></li></ul></li><li> <a class="is-flex" href="#总结"><span class="has-mr-6">6</span> <span>总结</span></a></li></ul></div></div></div><div class="column-right-shadow is-hidden-widescreen"><div class="card widget"><div class="card-content"><h3 class="menu-label"> 最新文章</h3><article class="media"><a href="/kafka/Kafka-Delay-Queue.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="Kafka延时队列方案探讨"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-31T04:37:16.000Z">2019-12-31</time></div> <a href="/kafka/Kafka-Delay-Queue.html" class="has-link-black-ter is-size-6">Kafka延时队列方案探讨</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/kafka/">kafka</a></p></div></div></article><article class="media"><a href="/database/innodb-record-level-locks.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL锁"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-08-26T10:59:26.000Z">2019-08-26</time></div> <a href="/database/innodb-record-level-locks.html" class="has-link-black-ter is-size-6">MySQL锁</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/database/">database</a></p></div></div></article><article class="media"><a href="/Spring/Spring-Circular-Dependencies.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="【Spring源码分析】循环依赖的处理"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-05-22T03:22:00.000Z">2019-05-22</time></div> <a href="/Spring/Spring-Circular-Dependencies.html" class="has-link-black-ter is-size-6">【Spring源码分析】循环依赖的处理</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/Spring/">Spring</a></p></div></div></article><article class="media"><a href="/JVM/JVM-Memory-Structure-Stack.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="java虚拟机栈的内存结构"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-19T13:22:00.000Z">2019-02-19</time></div> <a href="/JVM/JVM-Memory-Structure-Stack.html" class="has-link-black-ter is-size-6">java虚拟机栈的内存结构</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/JVM/">JVM</a></p></div></div></article><article class="media"><a href="/JVM/JVM-Memory-Structure-Menu.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="JVM内存结构-总纲"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-16T05:21:00.000Z">2019-02-16</time></div> <a href="/JVM/JVM-Memory-Structure-Menu.html" class="has-link-black-ter is-size-6">JVM内存结构-总纲</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/JVM/">JVM</a></p></div></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label"> 归档</h3><ul class="menu-list"><li> <a class="level is-marginless" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span> <span class="level-end"><span class="level-item tag">5</span></span></a></li><li> <a class="level is-marginless" href="/archives/2018/10/"><span class="level-start"><span class="level-item">十月 2018</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/1970/12/"><span class="level-start"><span class="level-item">十二月 1970</span></span> <span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label"> 标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"> <a class="tags has-addons" href="/tags/BUG/"><span class="tag">BUG</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Consul/"><span class="tag">Consul</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/DATABASE/"><span class="tag">DATABASE</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span> <span class="tag is-grey">2</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/JVM内存结构/"><span class="tag">JVM内存结构</span> <span class="tag is-grey">2</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Kafka/"><span class="tag">Kafka</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/LOCK/"><span class="tag">LOCK</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/MYSQL/"><span class="tag">MYSQL</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Spring-Cloud/"><span class="tag">Spring-Cloud</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span> <span class="tag is-grey">3</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/redis集群/"><span class="tag">redis集群</span> <span class="tag is-grey">2</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/事务/"><span class="tag">事务</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/优化/"><span class="tag">优化</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/分布式/"><span class="tag">分布式</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/每天进步一点点/"><span class="tag">每天进步一点点</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/源码分析/"><span class="tag">源码分析</span> <span class="tag is-grey">1</span></a></div></div></div></div></div></div></div><div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right"><div class="card widget"><div class="card-content"><h3 class="menu-label"> 最新文章</h3><article class="media"><a href="/kafka/Kafka-Delay-Queue.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="Kafka延时队列方案探讨"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-12-31T04:37:16.000Z">2019-12-31</time></div> <a href="/kafka/Kafka-Delay-Queue.html" class="has-link-black-ter is-size-6">Kafka延时队列方案探讨</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/kafka/">kafka</a></p></div></div></article><article class="media"><a href="/database/innodb-record-level-locks.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="MySQL锁"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-08-26T10:59:26.000Z">2019-08-26</time></div> <a href="/database/innodb-record-level-locks.html" class="has-link-black-ter is-size-6">MySQL锁</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/database/">database</a></p></div></div></article><article class="media"><a href="/Spring/Spring-Circular-Dependencies.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="【Spring源码分析】循环依赖的处理"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-05-22T03:22:00.000Z">2019-05-22</time></div> <a href="/Spring/Spring-Circular-Dependencies.html" class="has-link-black-ter is-size-6">【Spring源码分析】循环依赖的处理</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/Spring/">Spring</a></p></div></div></article><article class="media"><a href="/JVM/JVM-Memory-Structure-Stack.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="java虚拟机栈的内存结构"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-19T13:22:00.000Z">2019-02-19</time></div> <a href="/JVM/JVM-Memory-Structure-Stack.html" class="has-link-black-ter is-size-6">java虚拟机栈的内存结构</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/JVM/">JVM</a></p></div></div></article><article class="media"><a href="/JVM/JVM-Memory-Structure-Menu.html" class="media-left"><p class="image is-64x64"> <img class="thumbnail" src="/images/thumbnail.svg" alt="JVM内存结构-总纲"></p></a><div class="media-content"><div class="content"><div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-16T05:21:00.000Z">2019-02-16</time></div> <a href="/JVM/JVM-Memory-Structure-Menu.html" class="has-link-black-ter is-size-6">JVM内存结构-总纲</a><p class="is-size-7 is-uppercase"> <a class="has-link-grey -link" href="/categories/JVM/">JVM</a></p></div></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label"> 归档</h3><ul class="menu-list"><li> <a class="level is-marginless" href="/archives/2019/12/"><span class="level-start"><span class="level-item">十二月 2019</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2019/08/"><span class="level-start"><span class="level-item">八月 2019</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2019/05/"><span class="level-start"><span class="level-item">五月 2019</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2019/02/"><span class="level-start"><span class="level-item">二月 2019</span></span> <span class="level-end"><span class="level-item tag">5</span></span></a></li><li> <a class="level is-marginless" href="/archives/2018/10/"><span class="level-start"><span class="level-item">十月 2018</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2018/09/"><span class="level-start"><span class="level-item">九月 2018</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span> <span class="level-end"><span class="level-item tag">1</span></span></a></li><li> <a class="level is-marginless" href="/archives/1970/12/"><span class="level-start"><span class="level-item">十二月 1970</span></span> <span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label"> 标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"> <a class="tags has-addons" href="/tags/BUG/"><span class="tag">BUG</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Consul/"><span class="tag">Consul</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/DATABASE/"><span class="tag">DATABASE</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span> <span class="tag is-grey">2</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/JVM内存结构/"><span class="tag">JVM内存结构</span> <span class="tag is-grey">2</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Kafka/"><span class="tag">Kafka</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/LOCK/"><span class="tag">LOCK</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/MYSQL/"><span class="tag">MYSQL</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/Spring-Cloud/"><span class="tag">Spring-Cloud</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span> <span class="tag is-grey">3</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/redis集群/"><span class="tag">redis集群</span> <span class="tag is-grey">2</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/事务/"><span class="tag">事务</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/优化/"><span class="tag">优化</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/分布式/"><span class="tag">分布式</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/每天进步一点点/"><span class="tag">每天进步一点点</span> <span class="tag is-grey">1</span></a></div><div class="control"> <a class="tags has-addons" href="/tags/源码分析/"><span class="tag">源码分析</span> <span class="tag is-grey">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div id="power-count"><div class="outer"><div id="footer-info" class="inner"> &copy;2018 - 2020 神奇宝贝大师版权所有<br></div></div><div class="powered-by"><i class="fa fa-mouse-pointer"></i> <span id="busuanzi_container_site_pv">访问量:<span class="foot-count" id="busuanzi_value_site_pv">N^N</span></span><i class="fa fa-user"></i> <span id="busuanzi_container_site_uv">您是第<span class="foot-count" id="busuanzi_value_site_uv">N+1</span>个小伙伴</span></div></div><div class="container"><div class="level"><div class="level-start has-text-centered-mobile"> <a class="footer-logo is-block has-mb-6" href="/"><img src="/images/avatar.png" alt="【Spring源码分析】循环依赖的处理" height="28"></a><p class="is-size-7"> &copy; 2020 神奇宝贝大师&nbsp; Powered by <a href="http://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="external nofollow noopener noreferrer">Icarus</a></p></div><div class="level-end"><div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle"><p class="control"><a class="button is-white is-large" target="_blank" title="GitHub" href="https://github.com/HeyFL" rel="external nofollow noopener noreferrer"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://unpkg.com/mermaid@8.0.0/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script><script>function eventDelegate(e,n,t,l){function o(e){var t=e||window.event,o=t.target||t.srcElement,r=t.currentTarget;for(Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),o=t.length;0<=--o&&t.item(o)!==this;);return-1<o});o!==r;){if(o.matches(n)){var c=o;l.call(c,Array.prototype.slice.call(arguments))}o=o.parentNode}}t.split(".").forEach(function(t){Array.prototype.slice.call(document.querySelectorAll(e)).forEach(function(e){e.addEventListener(t,o)})})}eventDelegate("body",".gitter-open-chat-button","click",function(){$("#live2d-widget").attr("style","display:none")}),eventDelegate("body",".gitter-chat-embed-action-bar-item.gitter-chat-embed-action-bar-item-collapse-chat","click",function(){$("#live2d-widget").attr("style","")})</script><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN")</script><script src="/js/animation.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer="defer"></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer="defer"></script><script src="/js/gallery.js" defer="defer"></script><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" rel="external nofollow noopener noreferrer" target="_blank">Update my browser now</a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer="defer"></script><script>document.addEventListener("DOMContentLoaded",function(){outdatedBrowser({bgColor:"#f25648",color:"#ffffff",lowerThan:"flex"})})</script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back-to-top.js" defer="defer"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer="defer"></script><script src="/js/clipboard.js" defer="defer"></script><script src="/js/main.js" defer="defer"></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"> <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..."><span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"></div></div></div></div><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(无标题)"},CONTENT_URL:"/content.json"}</script><script src="/js/insight.js" defer="defer"></script><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/insight.css"><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right",width:80,height:150},mobile:{show:!1}})</script></body></html>